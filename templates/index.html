<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO with JWT Auth</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
</head>
<body>
    <h1>Socket.IO with FastAPI and JWT (WebSocket Only)</h1>
    <button id="connect-btn">Connect to WebSocket</button>
    <div id="messages"></div>

    <script>
        let socket;
        async function getToken() {
            const response = await fetch('http://localhost:8000/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: new URLSearchParams({
                username: 'vitaliy',
                password: '1234'
              }).toString()
            });
            const data = await response.json();
            return data.access_token
        }

        async function connectWebSocket() {
            const token = await getToken();
            console.log("Received Token:", token);

            socket = io("http://localhost:8000/", {
                query: {
                    auth_token: token
                },
                transports: ["websocket"]
            });

            socket.on("connect", () => {
                console.log("Connected to WebSocket server!");
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += "<p>Connected to WebSocket</p>";
            });

            socket.on("message", (data) => {
                console.log("Message from server:", data);
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += `<p>Server: ${data.data}</p>`;
            });

            socket.on("disconnect", () => {
                console.log("Disconnected from WebSocket server");
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += "<p>Disconnected from WebSocket</p>";
            });
        }

        document.getElementById('connect-btn').addEventListener('click', () => {
            connectWebSocket();
        });
    </script>
</body>
</html>
